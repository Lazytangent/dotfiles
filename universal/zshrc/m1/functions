# vim: ft=zsh

# Alembic Completion
function __alembic_commands() {
  local -a opts_help opts_verbose
  local expl help="--help"
  opts_help=("(: -)--help[show this help message and exit]")
  opts_verbose=("(-v --verbose)"{-v,--verbose}"[Use more verbose output]")

  case "$words[1]" in
    (branches)
      _arguments -s $opts_verbose $opts_help
      ;;
    (current)
      _arguments -s $opts_verbose $opts_help
      ;;
    (downgrade)
      _arguments -s "--sql[Don't emit SQL to database - dump to standard output/file instead. See docs on offline mode." "--tag[Arbitrary 'tag' name - can be used by custom env.py scripts." $opts_help
      ;;
    (edit)
      _arguments -s $opts_help
      ;;
    (ensure_version)
      _arguments -s "--sql[Don't emit SQL to database - dump to standard output/file instead. See docs on offline mode." $opts_help
      ;;
    (heads)
      _arguments -s $opts_verbose "--resolve-dependencies[Treat dependency versions as down revisions]" $opts_help
      ;;
    ("history")
      _arguments -s $opts_verbose "(-r --rev-range)"{-r,--rev-range}"[Specify a revision range; format is \[start\]:\[end\]]" "(-i --indicate-current)"{-i,--indicate-current}"[Indicate the current revision]" $opts_help
      ;;
    (init)
      _arguments -s $opts_help "(-t --template)"{-t,--template}"[Setup template for use with 'init']" "--package[Write empty __init__.py files to the environment and version locations]"
      ;;
    (list_templates)
      _arguments -s $opts_help
      ;;
    (merge)
      _arguments -s $opts_help "(-m --message)"{-m,--message}"[Message string to use with 'revision']" "--branch-label[Specify a branch label to apply to the new revision]" "--rev-id[Specify a hardcoded revision id instead of generating a new one]"
      ;;
    (revision)
      _arguments -s $opts_help
      ;;
  esac
  # _describe -t alembic-commands "alembic command" _alembic_subcommands
}

function __alembic_command() {
  local -a _command_args base_options opts_help
  local expl state help="--help"
  alembic_commands=(
    "branches:Show current branch points."
    "current:Display the current revision for a database."
    "downgrade:Revert to a previous version."
    "edit:Edit revision script(s) using \$EDITOR."
    "ensure_version:Create the alembic version table if it doesn't exit already."
    "heads:Show current available heads in the script directory."
    "history:List changeset scripts in chronological order."
    "init:Initialize a new scripts directory."
    "list_templates:List available templates."
    "merge:Merge two revisions together. Creates a new migration file."
    "revision:Create a new revision file."
    "show: Show the revision(s) denoted by the given symbol."
    "stamp:'stamp' the revision table with the given revision; don't run any migrations."
    "upgrade:Upgrade to a later version."
  )
  opts_help=("(: -)--help[Print usage]")

  _describe -t base_options 'alembic command' alembic_commands "$@"
  _arguments $(print -- -s) \
    $opts_help \
    "($help)--version[show program's version number and exit]" \
    "($help -c --config)"{-c=,--config=}"[Alternate config file; defaults to value of ALEMBIC_CONFIG environment variable, or \"alembic.ini\"]" \
    "($help -n --name)"{-n=,--name=}"[Name of section in .ini file to use for Alembic config]" \
    "($help)-x[Additional arguments consumed by custom env.py scripts, e.g. -x setting1=somesetting -x setting2=somesetting]" \
    "($help)--raiseerr[Raise a full stack track on error]" \
    "($help -): :->command" \
    "($help -)*:: :->option-or-argument"
}

function __alembic() {
  local state

  _arguments -C \
    '(-): :->command' \
    '(-)*:: :->option-or-argument'

  case $state in
    (command)
      __alembic_command
      ;;
    (option-or-argument)
      __alembic_commands
      ;;
  esac
}

compdef __alembic alembic

# TMUX
function t() {
  if tmux ls | grep -q $1; then
    local my_num=$(tmux ls | grep -c $1)
    if [[ $my_num = 1 ]]; then
      tmux attach -t $1
    else
      echo "Too many matches"
    fi
  else
    if [ "$TERM_PROGRAM" = tmux ]; then
      tmux new -s $1 -d
    else
      tmux new -s $1
    fi
  fi
}

function tt() {
  [[ -z "$1" ]] && { echo "Usage: tm <session>" >&2; return 1; }
  tmux has -t $1 && tmux attach -t $1 || tmux new -s $1
}

function ta() {
  tmux attach -t $1
}

function tad() {
  tmux attach -d -t $1
}

function ts() {
  tmux new-session -s "$@"
}

function tkss() {
  tmux kill-session -t $1
}

function tll() {
  tmuxp load "$@"
}

function __tmux-sessions() {
  local expl
  local -a sessions
  sessions=( ${${(f)"$(command tmux list-sessions)"}} )
  _describe -t sessions 'sessions' sessions "$@"
}

function __tmuxp-load() {
  local expl
  local -a templates
  templates=( ${${(f)"$(command find $HOME/.config/tmuxp -type f | xargs -n1 basename -s .yaml)"}} )
  _describe -t templates 'templates' templates "$@"
}

compdef __tmux-sessions tt ta tad tkss
compdef __tmuxp-load tll

function tdup() {
  if [ "$TERM_PROGRAM" = tmux ]; then
    current=$(tmux display-message -p '#S')
    tmux new -s "COPY_OF_$current"
  else
    echo "Not in a tmux session"
    echo "Usage: Run in a tmux session to make a copy of the current session"
  fi
}

function tc() {
  tmux new -s $1 -c $2
}

function tm() {
  tmux command-prompt -I $PWD -p "New session dir:" "attach -c %1"
  echo "Set tmux session directory to $(pwd)"
}

function tsw() {
  if tmux ls | grep -q $1; then
    local my_num=$(tmux ls | grep -c $1)
    if [[ $my_num = 1 ]]; then
      tmux switch -t $1
    else
      echo "Too many matches"
    fi
  else
    tmux new -s $1 -d
    tmux switch -t $1
  fi
}
